local MouseLock = {
    Settings = {
        Enabled = false,
        Key = Enum.KeyCode.X,
        Prediction = 0.086,
        AimPart = "Head",
        Snappiness = 1.5,
        FOVRadius = 150
    }
}

-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local LockedPlayer = nil

-- Debounce for smoothness keys
local lastSmoothChange = 0
local SMOOTHNESS_COOLDOWN = 0.15

-- ðŸ”” Smoothness notification
local function NotifySmoothness()
    StarterGui:SetCore("SendNotification", {
        Title = "MouseLock",
        Text = "Smoothness: " .. string.format("%.2f", MouseLock.Settings.Snappiness),
        Duration = 2
    })
end

-- ðŸ” Find ONE player inside FOV
local function FindTarget()
    local mousePos = UserInputService:GetMouseLocation()
    local closest, closestDist = nil, MouseLock.Settings.FOVRadius

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer
            and plr.Character
            and plr.Character:FindFirstChild(MouseLock.Settings.AimPart)
            and plr.Character:FindFirstChild("Humanoid")
            and plr.Character.Humanoid.Health > 0 then

            local part = plr.Character[MouseLock.Settings.AimPart]
            local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)

            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                if dist <= closestDist then
                    closest, closestDist = plr, dist
                end
            end
        end
    end

    return closest
end

-- ðŸŽ® Input handling
UserInputService.InputBegan:Connect(function(input, gp)
    if gp or input.UserInputType ~= Enum.UserInputType.Keyboard then return end

    local now = os.clock()

    -- Toggle lock (silent)
    if input.KeyCode == MouseLock.Settings.Key then
        MouseLock.Settings.Enabled = not MouseLock.Settings.Enabled
        LockedPlayer = MouseLock.Settings.Enabled and FindTarget() or nil
        return
    end

    -- Cooldown to prevent double notifications
    if now - lastSmoothChange < SMOOTHNESS_COOLDOWN then return end

    -- âž– Decrease smoothness
    if input.KeyCode == Enum.KeyCode.Minus
        or input.KeyCode == Enum.KeyCode.KeypadMinus then

        lastSmoothChange = now
        MouseLock.Settings.Snappiness = math.max(0.1, MouseLock.Settings.Snappiness - 0.1)
        NotifySmoothness()
    end

    -- âž• Increase smoothness
    if input.KeyCode == Enum.KeyCode.Equals
        or input.KeyCode == Enum.KeyCode.KeypadPlus then

        lastSmoothChange = now
        MouseLock.Settings.Snappiness += 0.1
        NotifySmoothness()
    end
end)

-- ðŸ”’ Stay locked until YOU unlock
RunService.RenderStepped:Connect(function()
    if not MouseLock.Settings.Enabled or not LockedPlayer then return end

    local char = LockedPlayer.Character
    if not char
        or not char:FindFirstChild(MouseLock.Settings.AimPart)
        or not char:FindFirstChild("Humanoid")
        or char.Humanoid.Health <= 0 then
        return
    end

    local part = char[MouseLock.Settings.AimPart]
    local predicted = part.Position + (part.AssemblyLinearVelocity * MouseLock.Settings.Prediction)
    local screenPos, onScreen = Camera:WorldToViewportPoint(predicted)

    if not onScreen then return end

    local mousePos = UserInputService:GetMouseLocation()
    local delta = Vector2.new(screenPos.X, screenPos.Y) - mousePos

    mousemoverel(
        delta.X * MouseLock.Settings.Snappiness,
        delta.Y * MouseLock.Settings.Snappiness
    )
end)
